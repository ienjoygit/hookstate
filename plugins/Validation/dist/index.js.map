{"version":3,"file":"index.js","sources":["../src/Touched.ts"],"sourcesContent":["\nimport { Path, Plugin, PluginTypeMarker, StateLink, DisabledTracking, StateValueAtPath } from 'react-hookstate';\n\nimport { InitialExtensions } from 'react-hookstate-initial';\n\nexport interface TouchedExtensions {\n    readonly touched: boolean;\n    readonly untouched: boolean;\n}\n\nconst PluginID = Symbol('Touched');\n\n// tslint:disable-next-line: function-name\nexport function Touched<S, E extends InitialExtensions>(\n    unused: PluginTypeMarker<S, E>\n): Plugin<E, TouchedExtensions> {\n    return {\n        id: PluginID,\n        instanceFactory: () => {\n            let touchedState: object | undefined = undefined;\n            const setTouched = (path: Path) => {\n                touchedState = touchedState || {};\n                let result = touchedState;\n                if (path.length === 0) {\n                    result[PluginID] = true\n                }\n                path.forEach((p, i) => {\n                    result[p] = result[p] || {}\n                    result = result[p]\n                    if (i === path.length - 1) {\n                        result[PluginID] = true;\n                    }\n                });\n            }\n            const getTouched = (path: Path): boolean | undefined => {\n                let result = touchedState;\n                let somethingVisted = false\n                let somethingTouched = false\n                path.forEach((p, i) => {\n                    if (result) {\n                        somethingVisted = true;\n                        somethingTouched = result[PluginID] ? true : somethingTouched;\n                        result = result[p];\n                    }\n                });\n                if (result) {\n                    return true;\n                }\n                if (!somethingVisted) {\n                    return false;\n                }\n                if (!somethingTouched) {\n                    return false;\n                }\n                return undefined;\n            }\n            const touched = (l: StateLink<StateValueAtPath, E>): boolean => {\n                const t = getTouched(l.path);\n                if (t !== undefined) {\n                    // For optimization purposes, there is nothing being used from the link value\n                    // as a result it is left untracked and no rerender happens for the result of this function\n                    // when the source value is updated.\n                    // We do the trick to fix it, we mark the value being 'deeply used',\n                    // so any changes for this value or any nested will trigger rerender.\n                    const _ = l.with(DisabledTracking).value;\n                    return t;\n                }\n                return l.extended.modified;\n            }\n            return {\n                onSet: (p) => setTouched(p),\n                extensions: ['touched', 'untouched'],\n                extensionsFactory: (l) => ({\n                    get touched() {\n                        return touched(l);\n                    },\n                    get untouched() {\n                        return !touched(l)\n                    },\n                })\n            }\n        }\n    }\n}\n"],"names":["DisabledTracking"],"mappings":";;;;;;AAUA,IAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC;;AAGnC,SAAgB,OAAO,CACnB,MAA8B;IAE9B,OAAO;QACH,EAAE,EAAE,QAAQ;QACZ,eAAe,EAAE;YACb,IAAI,YAAY,GAAuB,SAAS,CAAC;YACjD,IAAM,UAAU,GAAG,UAAC,IAAU;gBAC1B,YAAY,GAAG,YAAY,IAAI,EAAE,CAAC;gBAClC,IAAI,MAAM,GAAG,YAAY,CAAC;gBAC1B,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE;oBACnB,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAA;iBAC1B;gBACD,IAAI,CAAC,OAAO,CAAC,UAAC,CAAC,EAAE,CAAC;oBACd,MAAM,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,EAAE,CAAA;oBAC3B,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC,CAAA;oBAClB,IAAI,CAAC,KAAK,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;wBACvB,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC;qBAC3B;iBACJ,CAAC,CAAC;aACN,CAAA;YACD,IAAM,UAAU,GAAG,UAAC,IAAU;gBAC1B,IAAI,MAAM,GAAG,YAAY,CAAC;gBAC1B,IAAI,eAAe,GAAG,KAAK,CAAA;gBAC3B,IAAI,gBAAgB,GAAG,KAAK,CAAA;gBAC5B,IAAI,CAAC,OAAO,CAAC,UAAC,CAAC,EAAE,CAAC;oBACd,IAAI,MAAM,EAAE;wBACR,eAAe,GAAG,IAAI,CAAC;wBACvB,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,GAAG,gBAAgB,CAAC;wBAC9D,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;qBACtB;iBACJ,CAAC,CAAC;gBACH,IAAI,MAAM,EAAE;oBACR,OAAO,IAAI,CAAC;iBACf;gBACD,IAAI,CAAC,eAAe,EAAE;oBAClB,OAAO,KAAK,CAAC;iBAChB;gBACD,IAAI,CAAC,gBAAgB,EAAE;oBACnB,OAAO,KAAK,CAAC;iBAChB;gBACD,OAAO,SAAS,CAAC;aACpB,CAAA;YACD,IAAM,OAAO,GAAG,UAAC,CAAiC;gBAC9C,IAAM,CAAC,GAAG,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;gBAC7B,IAAI,CAAC,KAAK,SAAS,EAAE;;;;;;oBAMjB,IAAM,EAAC,GAAG,CAAC,CAAC,IAAI,CAACA,+BAAgB,CAAC,CAAC,KAAK,CAAC;oBACzC,OAAO,CAAC,CAAC;iBACZ;gBACD,OAAO,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC;aAC9B,CAAA;YACD,OAAO;gBACH,KAAK,EAAE,UAAC,CAAC,IAAK,OAAA,UAAU,CAAC,CAAC,CAAC,GAAA;gBAC3B,UAAU,EAAE,CAAC,SAAS,EAAE,WAAW,CAAC;gBACpC,iBAAiB,EAAE,UAAC,CAAC,IAAK,QAAC;oBACvB,IAAI,OAAO;wBACP,OAAO,OAAO,CAAC,CAAC,CAAC,CAAC;qBACrB;oBACD,IAAI,SAAS;wBACT,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAA;qBACrB;iBACJ,IAAC;aACL,CAAA;SACJ;KACJ,CAAA;CACJ;;;;"}
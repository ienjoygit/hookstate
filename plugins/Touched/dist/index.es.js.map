{"version":3,"file":"index.es.js","sources":["../src/Touched.ts"],"sourcesContent":["\nimport { Path, Plugin, PluginInstance, StateLink, Downgraded, StateValueAtPath } from '@hookstate/core';\n\nimport { Initial } from '@hookstate/initial';\n\nexport interface TouchedExtensions {\n    touched(): boolean;\n    untouched(): boolean;\n}\n\nconst PluginID = Symbol('Touched');\n\nclass TouchedPluginInstance implements PluginInstance {\n    private touchedState: object | undefined = undefined;\n\n    onSet(p: Path) {\n        this.setTouched(p)\n    }\n\n    setTouched = (path: Path) => {\n        this.touchedState = this.touchedState || {};\n        let result = this.touchedState;\n        if (path.length === 0) {\n            result[PluginID] = true\n        }\n        path.forEach((p, i) => {\n            result[p] = result[p] || {}\n            result = result[p]\n            if (i === path.length - 1) {\n                result[PluginID] = true;\n            }\n        });\n    }\n    getTouched = (path: Path): boolean | undefined => {\n        let result = this.touchedState;\n        let somethingVisted = false\n        let somethingTouched = false\n        path.forEach((p, i) => {\n            if (result) {\n                somethingVisted = true;\n                somethingTouched = result[PluginID] ? true : somethingTouched;\n                result = result[p];\n            }\n        });\n        if (result) {\n            return true;\n        }\n        if (!somethingVisted) {\n            return false;\n        }\n        if (!somethingTouched) {\n            return false;\n        }\n        return undefined;\n    }\n    touched = (l: StateLink<StateValueAtPath>): boolean => {\n        const t = this.getTouched(l.path);\n        if (t !== undefined) {\n            // For optimization purposes, there is nothing being used from the link value\n            // as a result it is left untracked and no rerender happens for the result of this function\n            // when the source value is updated.\n            // We do the trick to fix it, we mark the value being 'deeply used',\n            // so any changes for this value or any nested will trigger rerender.\n            const _ = l.with(Downgraded).value;\n            return t;\n        }\n        return Initial(l).modified();\n    }\n}\n\n// tslint:disable-next-line: function-name\nexport function Touched(): Plugin;\nexport function Touched<S>(self: StateLink<S>): TouchedExtensions;\nexport function Touched<S>(self?: StateLink<S>): Plugin | TouchedExtensions {\n    if (self) {\n        const [link, instance] = self.with(PluginID);\n        const inst = instance as TouchedPluginInstance;\n        return {\n            touched: () => inst.touched(link),\n            untouched: () => !inst.touched(link)\n        }\n    }\n    return {\n        id: PluginID,\n        instanceFactory: () => {\n            return new TouchedPluginInstance();\n        }\n    }\n}\n"],"names":[],"mappings":";;;AAUA,IAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC;AAEnC;IAAA;QAAA,iBAwDC;QAvDW,iBAAY,GAAuB,SAAS,CAAC;QAMrD,eAAU,GAAG,UAAC,IAAU;YACpB,KAAI,CAAC,YAAY,GAAG,KAAI,CAAC,YAAY,IAAI,EAAE,CAAC;YAC5C,IAAI,MAAM,GAAG,KAAI,CAAC,YAAY,CAAC;YAC/B,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE;gBACnB,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAA;aAC1B;YACD,IAAI,CAAC,OAAO,CAAC,UAAC,CAAC,EAAE,CAAC;gBACd,MAAM,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,EAAE,CAAA;gBAC3B,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC,CAAA;gBAClB,IAAI,CAAC,KAAK,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;oBACvB,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC;iBAC3B;aACJ,CAAC,CAAC;SACN,CAAA;QACD,eAAU,GAAG,UAAC,IAAU;YACpB,IAAI,MAAM,GAAG,KAAI,CAAC,YAAY,CAAC;YAC/B,IAAI,eAAe,GAAG,KAAK,CAAA;YAC3B,IAAI,gBAAgB,GAAG,KAAK,CAAA;YAC5B,IAAI,CAAC,OAAO,CAAC,UAAC,CAAC,EAAE,CAAC;gBACd,IAAI,MAAM,EAAE;oBACR,eAAe,GAAG,IAAI,CAAC;oBACvB,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,GAAG,gBAAgB,CAAC;oBAC9D,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;iBACtB;aACJ,CAAC,CAAC;YACH,IAAI,MAAM,EAAE;gBACR,OAAO,IAAI,CAAC;aACf;YACD,IAAI,CAAC,eAAe,EAAE;gBAClB,OAAO,KAAK,CAAC;aAChB;YACD,IAAI,CAAC,gBAAgB,EAAE;gBACnB,OAAO,KAAK,CAAC;aAChB;YACD,OAAO,SAAS,CAAC;SACpB,CAAA;QACD,YAAO,GAAG,UAAC,CAA8B;YACrC,IAAM,CAAC,GAAG,KAAI,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;YAClC,IAAI,CAAC,KAAK,SAAS,EAAE;;;;;;gBAMjB,IAAM,EAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,KAAK,CAAC;gBACnC,OAAO,CAAC,CAAC;aACZ;YACD,OAAO,OAAO,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC;SAChC,CAAA;KACJ;IArDG,qCAAK,GAAL,UAAM,CAAO;QACT,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAA;KACrB;IAmDL,4BAAC;CAAA,IAAA;AAKD,SAAgB,OAAO,CAAI,IAAmB;IAC1C,IAAI,IAAI,EAAE;QACA,IAAA,wBAAsC,EAArC,cAAI,EAAE,gBAA+B,CAAC;QAC7C,IAAM,MAAI,GAAG,QAAiC,CAAC;QAC/C,OAAO;YACH,OAAO,EAAE,cAAM,OAAA,MAAI,CAAC,OAAO,CAAC,MAAI,CAAC,GAAA;YACjC,SAAS,EAAE,cAAM,OAAA,CAAC,MAAI,CAAC,OAAO,CAAC,MAAI,CAAC,GAAA;SACvC,CAAA;KACJ;IACD,OAAO;QACH,EAAE,EAAE,QAAQ;QACZ,eAAe,EAAE;YACb,OAAO,IAAI,qBAAqB,EAAE,CAAC;SACtC;KACJ,CAAA;CACJ;;;;"}
{"version":3,"file":"index.js","sources":["../src/Touched.ts"],"sourcesContent":["import { Path, Plugin, Downgraded, StateValueAtPath, PluginCallbacks, PluginCallbacksOnSetArgument, State, StateMethods } from '@hookstate/core';\r\n\r\nimport { Initial } from '@hookstate/initial';\r\n\r\nexport interface TouchedExtensions {\r\n    touched(): boolean;\r\n    untouched(): boolean;\r\n}\r\n\r\nconst PluginID = Symbol('Touched');\r\n\r\nclass TouchedPluginInstance implements PluginCallbacks {\r\n    private touchedState: object | undefined = undefined;\r\n\r\n    onSet(p: PluginCallbacksOnSetArgument) {\r\n        this.setTouched(p.path)\r\n    }\r\n\r\n    setTouched = (path: Path) => {\r\n        this.touchedState = this.touchedState || {};\r\n        let result = this.touchedState;\r\n        if (path.length === 0) {\r\n            result[PluginID] = true\r\n        }\r\n        path.forEach((p, i) => {\r\n            result[p] = result[p] || {}\r\n            result = result[p]\r\n            if (i === path.length - 1) {\r\n                result[PluginID] = true;\r\n            }\r\n        });\r\n    }\r\n    getTouched = (path: Path): boolean | undefined => {\r\n        let result = this.touchedState;\r\n        let somethingVisted = false\r\n        let somethingTouched = false\r\n        path.forEach((p, i) => {\r\n            if (result) {\r\n                somethingVisted = true;\r\n                somethingTouched = result[PluginID] ? true : somethingTouched;\r\n                result = result[p];\r\n            }\r\n        });\r\n        if (result) {\r\n            return true;\r\n        }\r\n        if (!somethingVisted) {\r\n            return false;\r\n        }\r\n        if (!somethingTouched) {\r\n            return false;\r\n        }\r\n        return undefined;\r\n    }\r\n    touched = (l: StateMethods<StateValueAtPath>): boolean => {\r\n        const t = this.getTouched(l.path);\r\n        if (t !== undefined) {\r\n            // For optimization purposes, there is nothing being used from the link value\r\n            // as a result it is left untracked and no rerender happens for the result of this function\r\n            // when the source value is updated.\r\n            // We do the trick to fix it, we mark the value being 'deeply used',\r\n            // so any changes for this value or any nested will trigger rerender.\r\n            const _ = l.attach(Downgraded).value;\r\n            return t;\r\n        }\r\n        return Initial(l).modified();\r\n    }\r\n}\r\n\r\n// tslint:disable-next-line: function-name\r\nexport function Touched(): Plugin;\r\nexport function Touched<S>($this: State<S>): TouchedExtensions;\r\nexport function Touched<S>($this?: State<S>): Plugin | TouchedExtensions {\r\n    if ($this) {\r\n        const th = $this as State<S>;\r\n        const [instance, controls] = th.attach(PluginID);\r\n        if (instance instanceof Error) {\r\n            throw instance\r\n        }\r\n        const inst = instance as TouchedPluginInstance;\r\n        return {\r\n            touched: () => inst.touched(th),\r\n            untouched: () => !inst.touched(th)\r\n        }\r\n    }\r\n    return {\r\n        id: PluginID,\r\n        init: () => {\r\n            return new TouchedPluginInstance();\r\n        }\r\n    }\r\n}\r\n"],"names":["Downgraded","Initial"],"mappings":"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"}
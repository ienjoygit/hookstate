{"version":3,"file":"index.js","sources":["../src/Touched.ts"],"sourcesContent":["import { Path, Plugin, Downgraded, StateValueAtPath, PluginCallbacks, PluginCallbacksOnSetArgument, State, StateMethods } from '@hookstate/core';\n\nimport { Initial } from '@hookstate/initial';\n\nexport interface TouchedExtensions {\n    touched(): boolean;\n    untouched(): boolean;\n}\n\nconst PluginID = Symbol('Touched');\n\nclass TouchedPluginInstance implements PluginCallbacks {\n    private touchedState: object | undefined = undefined;\n\n    onSet(p: PluginCallbacksOnSetArgument) {\n        this.setTouched(p.path)\n    }\n\n    setTouched = (path: Path) => {\n        this.touchedState = this.touchedState || {};\n        let result = this.touchedState;\n        if (path.length === 0) {\n            result[PluginID] = true\n        }\n        path.forEach((p, i) => {\n            result[p] = result[p] || {}\n            result = result[p]\n            if (i === path.length - 1) {\n                result[PluginID] = true;\n            }\n        });\n    }\n    getTouched = (path: Path): boolean | undefined => {\n        let result = this.touchedState;\n        let somethingVisted = false\n        let somethingTouched = false\n        path.forEach((p, i) => {\n            if (result) {\n                somethingVisted = true;\n                somethingTouched = result[PluginID] ? true : somethingTouched;\n                result = result[p];\n            }\n        });\n        if (result) {\n            return true;\n        }\n        if (!somethingVisted) {\n            return false;\n        }\n        if (!somethingTouched) {\n            return false;\n        }\n        return undefined;\n    }\n    touched = (l: StateMethods<StateValueAtPath>): boolean => {\n        const t = this.getTouched(l.path);\n        if (t !== undefined) {\n            // For optimization purposes, there is nothing being used from the link value\n            // as a result it is left untracked and no rerender happens for the result of this function\n            // when the source value is updated.\n            // We do the trick to fix it, we mark the value being 'deeply used',\n            // so any changes for this value or any nested will trigger rerender.\n            const _ = l.attach(Downgraded).value;\n            return t;\n        }\n        return Initial(l).modified();\n    }\n}\n\n// tslint:disable-next-line: function-name\nexport function Touched(): Plugin;\nexport function Touched<S>($this: State<S>): TouchedExtensions;\nexport function Touched<S>($this?: State<S>): Plugin | TouchedExtensions {\n    if ($this) {\n        const th = $this as State<S>;\n        const [instance, controls] = th.attach(PluginID);\n        if (instance instanceof Error) {\n            throw instance\n        }\n        const inst = instance as TouchedPluginInstance;\n        return {\n            touched: () => inst.touched(th),\n            untouched: () => !inst.touched(th)\n        }\n    }\n    return {\n        id: PluginID,\n        init: () => {\n            return new TouchedPluginInstance();\n        }\n    }\n}\n"],"names":["Downgraded","Initial"],"mappings":"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"}